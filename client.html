<!DOCTYPE html>
<html lang=en>

<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script  src="http://code.jquery.com/jquery-latest.js"></script>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/start/jquery-ui.css" type="text/css"
        rel="Stylesheet" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js"></script>
    <script>
        var socketio = io.connect();
        socketio.on("connect", function () {
            socketio.emit("newUser", prompt("Enter the Username:"));
        });

        socketio.on("update", function (newInfo) {
            //update the chatlog with the message or information
            var p = document.getElementById("chatlog").appendChild(document.createElement("p"));
            p.appendChild(document.createTextNode(newInfo));
        });


        function switchRoom(room) {
            socketio.emit('switchRoom', room);
        }

        //a previous 330 student showed me her project, and hers used hrefs, so I tried to emulate that because I thought it was a good idea
        //in addition, some of the code for this function is from http://psitsmike.com/2011/10/node-js-and-socket-io-multiroom-chat-tutorial/
        socketio.on("updateRoom", function (rooms, current_room) {
            $("#allroom").empty();//clear the list of rooms
            for (var i = 0; i < rooms.length; i++) {
                if (rooms[i].roomName == current_room) {
                    $("#allroom").append("<div><b>" + rooms[i].roomName + "</b></div>");
                }
                else {
                    $('#allroom').append('<div><a href="#" onclick="switchRoom(\'' + rooms[i].roomName + '\')">' + rooms[i].roomName + '</a></div>');
                }
            }
        });

        socketio.on("updateRoomPWD", function (rooms, current_room) {
            $("#allroom").empty();//clear the list of rooms
            for (var i = 0; i < rooms.length; i++) {
                if (rooms[i].roomName == current_room) {
                    $("#allroom").append("<div><b>" + rooms[i].roomName + "</b></div>");
                }
                else {
                    if (rooms[i].hasOwnProperty('password')) {
                        console.log(rooms[i].hasOwnProperty('password'));
                        $('#allroom').append('<div><a href="#" onclick="switchRoom(\'' + rooms[i].roomName + '\')">' + rooms[i].roomName + '</a></div>');
                    }
                    else {
                        $('#allroom').append('<div><a href="#" onclick="switchRoom(\'' + rooms[i].roomName + '\')">' + rooms[i].roomName + '</a></div>');
                    }
                }
            }
        });

        //check if you successfully joined a password-protected room
         socketio.on("joinpwd", function (data) {
              var roomname = data.currentRoom;
              var user = data.currentUser;
              var roomPW = data.currentRoomPW;
              var isJoinRoom = data.joinRoom;

              if (roomPW != null) {
                var pw = prompt("Enter The Password of This Room");
                while (pw != roomPW) {
                  pw = prompt("Invalid Password! Try Again!");
                }

              }
              if (isJoinRoom) {
                $("#chatlog").empty();
                document.getElementById("chatlog").appendChild(document.createTextNode(user + " has enter room " + roomname + "!"));
                document.getElementById("chatlog").appendChild(document.createElement("br"));
              }
              socketio.emit("privateroom")
              socketio.emit("updateRoomPWD");
            });


        socketio.on("message_to_client", function (username, data) {
            var message = document.getElementById("chatlog").appendChild(document.createElement("p"));
            message.appendChild(document.createTextNode(username + ": " + data['message']));
        });

        function sendMessage() {
            var msg = document.getElementById("message_input").value;
            socketio.emit("message_to_server", { message: msg });
            $('#message_input').val("");
        }

        //create pub room
        function createNewRoom() {
            var roomName = document.getElementById("newRoom").value;
            socketio.emit("addRoom", roomName);
        }

        //create private room
        function createNewRoomPW() {
            var rmName = document.getElementById("roomnamePW").value;
            var rmPW = document.getElementById("roomPW").value;
            socketio.emit("newRoomPW", { roomName: rmName, roomPW: rmPW });
        }

         //prompt for pwd
        //  socketio.on("enterpwd", function (room) {
        //     //when a user is trying to get into a password protected room, prompt them for the password
        //     socketio.emit("checkPw", room, prompt("What's the Password?"));
        // });

        //enter room pwd
        function privateRoom(room) {
            socketio.emit('privateRoom', roomName);//or room? 
        }


        $(function () {
            // when the client hits ENTER on their keyboard
            $('#nRoomPW').keypress(function (e) {
                if (e.which == 13) {
                    $(this).blur();
                    $('#createPWDRoom').focus().click();
                }
            });
        });

        function pm() {
            var msg = document.getElementById("pm").value;
            var receiver = document.getElementById("receiver").value;
            socketio.emit("pm", receiver, { message: msg });
        }

        socketio.on("pm2", function (username, data) {
            var secretMsg = document.getElementById("chatlog").appendChild(document.createElement("p"));
            secretMsg.appendChild(document.createTextNode("Private Message from" + username + ": " + data['message']));
        });


        function kick() {
            var username = document.getElementById("kickban").value;
            socketio.emit("kickuser", username);
        }
        function ban() {
            var username = document.getElementById("kickban").value;
            socketio.emit("banuser", username);
        }

      //display people in the room
      socketio.on("ppl", function(people) {
			//list everyone in the room
			$('#people').empty();
         document.getElementById("people").innerHTML = people;
      });
      

        $(function () {
            // when the client hits ENTER on their keyboard
            $('#message_input').keypress(function (e) {
                if (e.which == 13) {
                    $(this).blur();
                    $('#msg').focus().click();
                }
            });
        });


    </script>
    <title>Chat Room</title>
    <style>
        body {
            background: burlywood;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="message"> SEND A MESSAGE TO CHAT HERE:
        <input type="text" id="message_input" />
        <button id="msg" onclick="sendMessage()">send</button>
    </div>

    <h3>Current All Rooms</h3>
    <div id="allroom"></div>
    <h3>Create a new room</h3>
    <input type="text" id="newRoom" />
    <button onclick="createNewRoom()">Create</button>

    <h3>Create a Private Room</h3>
    <div id="nRoomPW">
        <input type="text" id="roomnamePW" placeholder="Room Name">
        <input type="password" id="roomPW" placeholder="Password">
        <button id="createPWDRoom" onclick="createNewRoomPW()">Create</button>
        <hr>
    </div>

    <h3>Private Message</h3>
    Send pm to: <input type="text" id="receiver" />
    Message: <input type="text" id="pm" />
    <button onclick="pm()">Send Private Message!</button>
    
    <h3>Kick/Ban User from Current Room</h3>
    Enter user to kick/ban: <input type="text" id="kickban" />
    <button onclick="kick()">Kick!</button>
    <button onclick="ban()">Ban!</button>
   
    ------------------------------------------------------------------------------------------------------------------------------



    <div id="chatlog"></div>
    <div id="people"> 
    <h3>Current people in the room:</h3>
    </div>

</body>

</html>
